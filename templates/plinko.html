{% extends "base.html" %}

{% block title %}Plinko - Sarcastic Casino{% endblock %}

{% block content %}
<div class="plinko-game-container">
    <!-- Sidebar Controls -->
    <div class="game-sidebar">
        <div class="sidebar-header">
            <h2>Plinko</h2>
        </div>
        
        <div class="controls-section">
            <div class="bet-amount-section">
                <label for="betAmount">Bet Amount</label>
                <div class="bet-input-group">
                    <button class="bet-modifier" onclick="modifyBet(0.5)">Â½</button>
                    <input type="number" id="betAmount" value="100" min="1" max="10000" step="1">
                    <button class="bet-modifier" onclick="modifyBet(2)">2Ã—</button>
                </div>
            </div>
            
            <div class="quick-bets">
                <button class="quick-bet-btn" onclick="setBetAmount(100)">$100</button>
                <button class="quick-bet-btn" onclick="setBetAmount(500)">$500</button>
                <button class="quick-bet-btn" onclick="setBetAmount(1000)">$1K</button>
                <button class="quick-bet-btn" onclick="setBetAmount(5000)">$5K</button>
            </div>
            
            <div class="risk-section">
                <label>Risk</label>
                <div class="risk-selector">
                    <button class="risk-btn" data-risk="low" onclick="selectRisk('low')">Low</button>
                    <button class="risk-btn active" data-risk="medium" onclick="selectRisk('medium')">Medium</button>
                    <button class="risk-btn" data-risk="high" onclick="selectRisk('high')">High</button>
                </div>
            </div>
            
            <button id="betButton" class="bet-button" onclick="placeBet()">
                <span>Bet</span>
            </button>
        </div>
        
        <div class="wallet-info">
            <div class="balance">
                <span class="balance-label">Balance:</span>
                <span class="balance-amount" id="walletBalance">Loading...</span>
            </div>
        </div>
    </div>
    
    <!-- Main Game Area -->
    <div class="game-area">
        <!-- Ball Drop Zone -->
        <div class="ball-drop-zone">
            <div id="ball" class="ball" style="display: none;"></div>
        </div>
        
        <!-- Plinko Board -->
        <div id="plinkoBoard" class="plinko-board">
            <!-- Pegs will be generated by JavaScript -->
        </div>
        
        <!-- Multiplier Slots -->
        <div class="multiplier-slots">
            {% for i in range(board_data.multipliers|length) %}
            <div class="multiplier-slot" 
                 data-multiplier="{{ board_data.multipliers[i] }}"
                 data-slot="{{ i }}"
                 style="background-color: {{ board_data.slot_colors[board_data.multipliers[i]] }};">
                <div class="slot-multiplier">{{ board_data.slot_names[i] }}</div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Results Display -->
        <div id="resultDisplay" class="result-panel" style="display: none;">
            <div class="result-content">
                <h3 id="resultTitle" class="result-title"></h3>
                <p id="resultMessage" class="result-message"></p>
                <div id="winAmount" class="win-amount"></div>
            </div>
        </div>
    </div>
</div>

<style>
/* Main Container */
.plinko-game-container {
    display: flex;
    min-height: 100vh;
    background: #1a1b23;
    color: white;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* Sidebar Controls */
.game-sidebar {
    width: 300px;
    background: #2a2d39;
    padding: 20px;
    border-right: 1px solid #3a3d49;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.sidebar-header {
    text-align: center;
    margin-bottom: 10px;
}

.controls-section {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.bet-amount-section {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.bet-input-group {
    display: flex;
    align-items: center;
    background: #1a1b23;
    border-radius: 8px;
    padding: 4px;
    margin-bottom: 10px;
}

.bet-input-group input {
    flex: 1;
    background: transparent;
    border: none;
    color: white;
    padding: 12px 16px;
    font-size: 1rem;
    font-weight: 600;
}

.bet-input-group input:focus {
    outline: none;
}

.bet-buttons {
    display: flex;
    gap: 4px;
}

.bet-modifier {
    background: #3a3d49;
    border: none;
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
}

.bet-modifier:hover {
    background: #4a4d59;
}

.quick-bets {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
}

.quick-bet-btn {
    background: #3a3d49;
    border: none;
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.85rem;
    transition: all 0.2s ease;
}

.quick-bet-btn:hover {
    background: #4a4d59;
}

/* Risk Section */
.risk-section {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.risk-selector {
    display: flex;
    gap: 8px;
}

.risk-btn {
    flex: 1;
    background: #3a3d49;
    border: none;
    color: white;
    padding: 10px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
}

.risk-btn.active {
    background: #00d4aa;
    color: white;
}

.risk-btn:hover:not(.active) {
    background: #4a4d59;
}

/* Bet Button */
.bet-button {
    background: #00d4aa;
    border: none;
    color: white;
    padding: 16px 32px;
    border-radius: 8px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-top: auto;
}

.bet-button:hover {
    background: #00c49a;
    transform: translateY(-1px);
}

.bet-button:disabled {
    background: #3a3d49;
    cursor: not-allowed;
    transform: none;
}

/* Game Area */
.game-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    background: #1a1b23;
    position: relative;
}

.ball-drop-zone {
    position: relative;
    width: 100%;
    height: 50px;
    display: flex;
    justify-content: center;
    align-items: center;
}

.ball {
    width: 12px;
    height: 12px;
    background: radial-gradient(circle at 30% 30%, #ffffff, #00d4aa, #00b89a);
    border-radius: 50%;
    position: absolute;
    z-index: 1000;
    box-shadow: 0 2px 8px rgba(0, 212, 170, 0.5);
    transition: all 0.1s ease;
}

/* Plinko Board */
.plinko-board {
    width: 800px;
    height: 500px;
    position: relative;
    background: linear-gradient(180deg, #2a2d39 0%, #1a1b23 100%);
    border-radius: 12px;
    border: 2px solid #3a3d49;
    margin: 20px 0;
}

.peg {
    width: 6px;
    height: 6px;
    background: #ffffff;
    border-radius: 50%;
    position: absolute;
    box-shadow: 0 0 4px rgba(255, 255, 255, 0.3);
}

/* Multiplier Slots */
.multiplier-slots {
    display: flex;
    gap: 1px;
    margin-top: 10px;
    width: 800px;
}

.multiplier-slot {
    flex: 1;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    position: relative;
    transition: all 0.3s ease;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.multiplier-slot:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.multiplier-slot.winning {
    animation: slotWin 1s ease-in-out;
    box-shadow: 0 0 20px rgba(0, 212, 170, 0.6);
}

@keyframes slotWin {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.slot-multiplier {
    color: white;
    font-weight: 600;
    font-size: 0.85rem;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
}

/* Result Panel */
.result-panel {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(42, 45, 57, 0.95);
    border-radius: 12px;
    padding: 30px;
    text-align: center;
    border: 2px solid #00d4aa;
    backdrop-filter: blur(10px);
    animation: resultSlide 0.4s ease-out;
    z-index: 1001;
}

@keyframes resultSlide {
    from { 
        transform: translate(-50%, -50%) scale(0.8); 
        opacity: 0; 
    }
    to { 
        transform: translate(-50%, -50%) scale(1); 
        opacity: 1; 
    }
}

.result-title {
    color: #00d4aa;
    font-size: 1.5rem;
    margin: 0 0 10px 0;
    font-weight: 600;
}

.result-message {
    color: #8b949e;
    font-size: 1rem;
    margin: 0 0 15px 0;
}

.win-amount {
    color: white;
    font-size: 2rem;
    font-weight: 700;
}

/* Responsive Design */
@media (max-width: 1200px) {
    .plinko-board {
        width: 600px;
        height: 400px;
    }
    
    .multiplier-slots {
        width: 600px;
    }
}

@media (max-width: 768px) {
    .plinko-game-container {
        flex-direction: column;
        min-height: auto;
    }
    
    .game-sidebar {
        width: 100%;
        padding: 15px;
    }
    
    .plinko-board {
        width: 100%;
        max-width: 500px;
        height: 350px;
    }
    
    .multiplier-slots {
        width: 100%;
        max-width: 500px;
    }
    
    .quick-bets {
        grid-template-columns: repeat(4, 1fr);
    }
}
</style>

<script>
let isDropping = false;
const boardData = {{ board_data|tojson }};
const walletCurrency = '{{ wallet.currency }}';

// Initialize the game
document.addEventListener('DOMContentLoaded', function() {
    initializePlinkoBoard();
    initializeControls();
    initializeWalletBalance();
});

function initializePlinkoBoard() {
    const board = document.getElementById('plinkoBoard');
    const rows = 16; // Fixed to match the design
    const boardWidth = board.offsetWidth - 40;
    const boardHeight = board.offsetHeight - 40;
    
    // Clear existing pegs
    board.innerHTML = '';
    
    // Generate pegs in triangular pattern
    for (let row = 0; row < rows; row++) {
        const pegsInRow = row + 1;
        const rowY = (boardHeight / rows) * row + 30;
        
        for (let peg = 0; peg < pegsInRow; peg++) {
            const pegElement = document.createElement('div');
            pegElement.className = 'peg';
            
            // Calculate peg position for centered triangular arrangement
            const spacing = boardWidth / (rows + 1);
            const rowOffset = (boardWidth - (pegsInRow - 1) * spacing) / 2;
            const pegX = rowOffset + (peg * spacing) - 3; // Center the peg
            
            pegElement.style.left = pegX + 'px';
            pegElement.style.top = rowY + 'px';
            
            board.appendChild(pegElement);
        }
    }
}

function initializeControls() {
    const betInput = document.getElementById('betAmount');
    const dropBtn = document.getElementById('betButton');
    
    // Drop ball button
    dropBtn.addEventListener('click', dropBall);
}

async function dropBall() {
    if (isDropping) return;
    
    const betAmount = parseFloat(document.getElementById('betAmount').value);
    if (!betAmount || betAmount <= 0) {
        alert('Please enter a valid bet amount');
        return;
    }
    
    isDropping = true;
    document.getElementById('betButton').disabled = true;
    document.getElementById('resultDisplay').style.display = 'none';
    
    try {
        // Start ball animation first
        const animationPromise = animateBallDrop();
        
        // Make API call simultaneously
        const response = await fetch('/api/plinko/bet', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                amount: betAmount,
                risk_level: getCurrentRiskLevel()
            })
        });
        
        const result = await response.json();
        
        // Wait for animation to complete
        await animationPromise;
        
        // Show results
        setTimeout(() => {
            displayResult(result);
            updateWalletBalance(result);
            isDropping = false;
            document.getElementById('betButton').disabled = false;
        }, 500);
        
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
        isDropping = false;
        document.getElementById('betButton').disabled = false;
    }
}

function animateBallDrop() {
    return new Promise((resolve) => {
        const ball = document.getElementById('ball');
        const board = document.getElementById('plinkoBoard');
        
        // Reset ball position to center top
        ball.style.display = 'block';
        ball.style.left = '50%';
        ball.style.top = '-10px';
        ball.style.transform = 'translateX(-50%)';
        
        // Animation parameters
        let position = 50; // Start at center (percentage)
        let currentRow = 0;
        const totalRows = 16;
        
        const animationInterval = setInterval(() => {
            if (currentRow >= totalRows) {
                clearInterval(animationInterval);
                
                // Calculate final slot position
                const finalSlotIndex = Math.floor((position / 100) * boardData.multipliers.length);
                const clampedIndex = Math.max(0, Math.min(boardData.multipliers.length - 1, finalSlotIndex));
                
                // Animate to final position in multiplier slot
                setTimeout(() => {
                    const slotWidth = 100 / boardData.multipliers.length;
                    const slotCenter = (clampedIndex * slotWidth) + (slotWidth / 2);
                    
                    ball.style.top = (board.offsetHeight + 25) + 'px';
                    ball.style.left = slotCenter + '%';
                    
                    // Highlight winning slot
                    const slots = document.querySelectorAll('.multiplier-slot');
                    if (slots[clampedIndex]) {
                        slots[clampedIndex].classList.add('winning');
                        
                        setTimeout(() => {
                            slots[clampedIndex].classList.remove('winning');
                            ball.style.display = 'none';
                            resolve(); // Animation complete
                        }, 800);
                    } else {
                        ball.style.display = 'none';
                        resolve();
                    }
                }, 200);
                
                return;
            }
            
            // Simulate realistic bouncing with some center bias
            const bounceIntensity = 15 + (Math.random() * 10); // Variable bounce
            const bounce = (Math.random() - 0.5) * bounceIntensity;
            
            // Add slight center bias to prevent extreme outcomes
            const centerBias = (50 - position) * 0.1;
            position += bounce + centerBias;
            
            // Keep within reasonable bounds
            position = Math.max(10, Math.min(90, position));
            
            // Update ball position with faster animation
            const rowHeight = board.offsetHeight / totalRows;
            ball.style.top = (currentRow * rowHeight + 20) + 'px';
            ball.style.left = position + '%';
            
            currentRow++;
        }, 120); // Faster animation (was 200ms, now 120ms)
    });
}

function displayResult(result) {
    const resultDisplay = document.getElementById('resultDisplay');
    const resultTitle = document.getElementById('resultTitle');
    const resultMessage = document.getElementById('resultMessage');
    const winAmount = document.getElementById('winAmount');
    
    if (result.success) {
        if (result.win_amount > 0) {
            resultTitle.textContent = 'ðŸŽ‰ WIN!';
            resultMessage.textContent = `Ball landed in ${result.slot_name} slot!`;
            winAmount.textContent = `+${getCurrencySymbol()}${result.win_amount.toFixed(2)}`;
        } else {
            resultTitle.textContent = 'ðŸ˜” No Win';
            resultMessage.textContent = `Ball landed in ${result.slot_name} slot.`;
            winAmount.textContent = `${getCurrencySymbol()}0.00`;
        }
    } else {
        resultTitle.textContent = 'âŒ Error';
        resultMessage.textContent = result.message || 'Something went wrong.';
        winAmount.textContent = '';
    }
    
    resultDisplay.style.display = 'block';
    
    // Auto-hide after 3 seconds
    setTimeout(() => {
        resultDisplay.style.display = 'none';
    }, 3000);
}

function updateWalletBalance(result) {
    if (result.success && result.wallet_balance !== undefined) {
        const balanceDisplay = document.getElementById('walletBalance');
        balanceDisplay.textContent = `${getCurrencySymbol()}${result.wallet_balance.toFixed(2)}`;
    }
}

function getCurrencySymbol() {
    switch (walletCurrency) {
        case 'EUR': return 'â‚¬';
        case 'BTC': return 'â‚¿';
        case 'USD':
        default: return '$';
    }
}

// Handle window resize
window.addEventListener('resize', () => {
    setTimeout(initializePlinkoBoard, 100);
});

// Missing functions for bet controls
function modifyBet(multiplier) {
    const betInput = document.getElementById('betAmount');
    const currentAmount = parseFloat(betInput.value) || 0;
    const newAmount = currentAmount * multiplier;
    betInput.value = Math.max(1, Math.round(newAmount));
}

function setBetAmount(amount) {
    document.getElementById('betAmount').value = amount;
}

function selectRisk(riskLevel) {
    // Update active risk button
    document.querySelectorAll('.risk-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-risk="${riskLevel}"]`).classList.add('active');
    
    // Update multipliers based on risk level
    updateMultipliers(riskLevel);
}

function updateMultipliers(riskLevel) {
    // Make API call to get updated board data
    fetch(`/api/plinko/board-data?risk=${riskLevel}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update multiplier slots with new values and colors
                const slots = document.querySelectorAll('.multiplier-slot');
                data.board_data.multipliers.forEach((multiplier, index) => {
                    if (slots[index]) {
                        slots[index].setAttribute('data-multiplier', multiplier);
                        slots[index].style.backgroundColor = data.board_data.slot_colors[multiplier];
                        slots[index].querySelector('.slot-multiplier').textContent = `${multiplier}x`;
                    }
                });
                
                // Update global board data
                Object.assign(boardData, data.board_data);
            }
        })
        .catch(error => {
            console.error('Error updating multipliers:', error);
        });
}

function placeBet() {
    dropBall();
}

function getCurrentRiskLevel() {
    const activeRiskBtn = document.querySelector('.risk-btn.active');
    return activeRiskBtn ? activeRiskBtn.getAttribute('data-risk') : 'high';
}

// Initialize wallet balance display
function initializeWalletBalance() {
    const balanceElement = document.getElementById('walletBalance');
    if (typeof wallet !== 'undefined') {
        balanceElement.textContent = `${getCurrencySymbol()}${wallet.balance.toFixed(2)}`;
    } else {
        balanceElement.textContent = 'Loading...';
    }
}
</script>
{% endblock %} 